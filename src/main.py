import streamlit as st
import pandas as pd
import altair as alt

from etl import run_pipeline

st.title("üìä CSV Viewer")

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
uploaded_file = st.file_uploader(
    "–ó–∞–≥—Ä—É–∑–∏ CSV —Ñ–∞–π–ª",
    type=["csv"]
)

# –ü—Ä–∏–≤–æ–¥–∏–º –∫ —á–∏—Å–ª—É (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
if uploaded_file is not None:
    # –ß—Ç–µ–Ω–∏–µ CSV
    df = pd.read_csv(uploaded_file)

    # –í—Å—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    st.subheader("–î–∞–Ω–Ω—ã–µ")

    df = run_pipeline(df)

    st.dataframe(df, use_container_width=True, height=600)

    limit = st.number_input(
        "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ä–∞—Å—Ö–æ–¥–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
        min_value=0,
        max_value=10000,
        value=1500,
        step=100
    )

    st.subheader(f"üìä –¢—Ä–∞—Ç—ã –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏ (<{limit})")

    df["Transaction date"] = pd.to_datetime(df["Transaction date"], errors="coerce")

    # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ö–æ–¥—ã < 5000
    filtered = df[
        (df["Debits"] < 0) &
        (df["Debits"] > -limit)
        ].copy()

    # –°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
    filtered["expense"] = filtered["Debits"].abs()

    # –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
    filtered["weekday"] = filtered["Transaction date"].dt.day_name()

    weekday_order = [
        "Monday", "Tuesday", "Wednesday",
        "Thursday", "Friday", "Saturday", "Sunday"
    ]

    week_spend = (
        filtered.groupby("weekday")["expense"]
        .mean()
        .reindex(weekday_order)
    )

    chart = alt.Chart(week_spend.reset_index()).mark_bar().encode(
        x=alt.X("weekday", sort=weekday_order, title="Day of week"),
        y=alt.Y("expense", title="Expenses"),
    )

    st.altair_chart(chart, use_container_width=True)

    st.subheader("üìä –°—É–º–º–∞ —Ç—Ä–∞—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")

    # –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —á–∏—Å–ª—É
    df["Debits"] = pd.to_numeric(df["Debits"], errors="coerce")

    # —Ä–∞—Å—Ö–æ–¥—ã = –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ Debits
    cat_df = df[df["Debits"] < 0].copy()
    cat_df["expense"] = cat_df["Debits"].abs()

    by_cat = (
        cat_df.groupby("category", as_index=False)["expense"]
        .sum()
    )

    chart = alt.Chart(by_cat).mark_bar().encode(
        x=alt.X("expense:Q", title="Total expenses (PLN)"),
        y=alt.Y("category:N", sort="-x", title="Category"),
        tooltip=["category:N", alt.Tooltip("expense:Q", format=".2f")]
    )

    st.altair_chart(chart, use_container_width=True)

    st.subheader("üìä –î–æ—Ö–æ–¥—ã (‚Üí) –∏ —Ä–∞—Å—Ö–æ–¥—ã (‚Üê) –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")

    tmp = df.copy()
    tmp["Debits"] = pd.to_numeric(tmp["Debits"], errors="coerce")
    tmp["Credits"] = pd.to_numeric(tmp["Credits"], errors="coerce")

    tmp["category"] = tmp["category"].fillna("Other")

    # –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ
    exp = (
        tmp[tmp["Debits"] < 0]
        .assign(amount=lambda d: d["Debits"].abs())
        .groupby("category", as_index=False)["amount"].sum()
        .assign(side="expense", value_signed=lambda d: -d["amount"])
    )

    inc = (
        tmp[tmp["Credits"] > 0]
        .assign(amount=lambda d: d["Credits"])
        .groupby("category", as_index=False)["amount"].sum()
        .assign(side="income", value_signed=lambda d: d["amount"])
    )

    by_cat = pd.concat([exp, inc], ignore_index=True)

    chart = alt.Chart(by_cat).mark_bar().encode(
        y=alt.Y("category:N", sort=alt.EncodingSortField(field="value_signed", op="sum", order="descending"),
                title="Category"),
        x=alt.X("value_signed:Q", title="PLN (‚Üê expenses | income ‚Üí)"),
        tooltip=[
            "category:N",
            "side:N",
            alt.Tooltip("amount:Q", format=".2f", title="amount"),
            alt.Tooltip("value_signed:Q", format=".2f", title="signed")
        ]
    )

    st.altair_chart(chart, use_container_width=True)


